
rule anti_vm_graphic_driver_query
{
   meta:
      description = "Generic Anti-VM technique based on a WMI query targeting the video controller of the system"
      author = "HomardBoy"
      reference = "32b8a98b6b3db245201d0b91a8d0a200"
      date = "2021-01-13"
    strings:
		$wmi_req = "SELECT * FROM Win32_VideoController"
		$vendor1 = "QEMU"
		$vendor2 = "VirtualBox"
		$vendor3 = "VMware"
		$vendor4 = "VM Additions"
    condition:
       ($wmi_req1) and (1 of ($vendor*))
}

rule anti_vm_wine_kernel32_function
{
   meta:
      description = "Generic Anti-VM technique based on the detection of WINE through a kernel32.dll export"
      author = "HomardBoy"
      reference = "32b8a98b6b3db245201d0b91a8d0a200"
      date = "2021-01-13"
    strings:
		$func = "wine_get_unix_file_name"
    condition:
       $func
}

rule anti_vm_hard_drive_scsi
{
   meta:
      description = "Generic Anti-VM technique based on the SCSI Hard-drive name"
      author = "HomardBoy"
      reference = "32b8a98b6b3db245201d0b91a8d0a200"
      date = "2021-01-13"
    strings:
		$hdd1 = "HARDWARE\DEVICEMAP\Scsi\Scsi Port 2\Scsi Bus 0\Target Id 0\Logical Unit Id 0"
		$hdd2 = "HARDWARE\DEVICEMAP\Scsi\Scsi Port 1\Scsi Bus 0\Target Id 0\Logical Unit Id 0"
		$hdd3 = "HARDWARE\DEVICEMAP\Scsi\Scsi Port 0\Scsi Bus 0\Target Id 0\Logical Unit Id 0"
    condition:
       1 of them
}

rule anti_vm_registry_artefacts
{
   meta:
      description = "Generic Anti-VM technique based on some vendor's specific registry key"
      author = "HomardBoy"
      reference = "32b8a98b6b3db245201d0b91a8d0a200"
      date = "2021-01-13"
    strings:
		$reg1 = "HARDWARE\Description\System"
		$reg2 = "SOFTWARE\Oracle\VirtualBox Guest Additions"
		$reg3 = "SOFTWARE\VMware, Inc.\VMware Tools"
		$reg4 = "SYSTEM\ControlSet001\Control\Class\{4D36E968-E325-11CE-BFC1-08002BE10318}\0000\Settings"
    condition:
       1 of ($reg*)
}

rule anti_vm_filesystem_artefacts
{
   meta:
      description = "Generic Anti-VM technique based on some vendor's specific files or folder"
      author = "HomardBoy"
      reference = "32b8a98b6b3db245201d0b91a8d0a200"
      date = "2021-01-13"
    strings:
      		$file1 = "C:\file.exe"
		$file2 = "C:\PROGRAM FILES\VMWARE\VMWARE TOOLS\"
		$file3 = "C:\\WINDOWS\\system32\\drivers\\VBoxMouse.sys"
		$file4 = "C:\\WINDOWS\\system32\\drivers\\vmmouse.sys"
		$file5 = "C:\\WINDOWS\\system32\\drivers\\vmhgfs.sys"
    condition:
       1 of them
}