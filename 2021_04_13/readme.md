Dridex - Dynamic Unpacking

MD5: 6a8401448a5bd2b540850f811b20a66d

File: dridex.exe

Original name: npkpdb.dll

High entropy on the .text1 section (not a regular section name)

Only a very few strings in plaintext => This is 100% packed

========================================

# Dynamic Unpacking

After firing up x64dbg, I placed a few breakpoints. In order to intercept the unpacked version in memory:
```
- VirtualAlloc
- VirtualProtect
- WriteProcessMemory
```

In order to intercept process interaction:
```
- CreateProcessInternalW
- CreateRemoteThread
- CreateRemoteProcess
- NtResumeThread
```

* First VirtualAlloc() syscall: Store a buffer with what's look like a mapped PE (weird header and weird bytes repartition)

* Second VirtualAlloc() syscall: Store an executable with a PE that's looks mapped, and similar to the previous one.

* Third VirtualAlloc() syscall: Store a different mapped executable.

* VirtualProtect() syscall

We can start to look for some weird call / jump:

* 'call eax' at 0x005224A1

* 'call edx' at 0x00522535

* 'jmp eax'  at 0x005225CC

* 'call eax' at 0x005226D9 

It turns out that 0x005226D9 (call eax) is out call to VirtualProtect)

Finally, 0x005225CC (jump eax) takes us to the malware's entrypoint:
```
100062B0 | 55                       | push ebp                                    
100062B1 | 8BEC                     | mov ebp,esp                                 
100062B3 | 51                       | push ecx                                    
100062B4 | 6A 00                    | push 0                                      
100062B6 | 8D4D FC                  | lea ecx,dword ptr ss:[ebp-4]                
100062B9 | E8 52DD0000              | call dridex.10014010                        
100062BE | A0 08800210              | mov al,byte ptr ds:[10028008]               
100062C3 | 84C0                     | test al,al                                  
100062C5 | 74 6C                    | je dridex.10006333                          
100062C7 | 837D 0C 01               | cmp dword ptr ss:[ebp+C],1                  
100062CB | 56                       | push esi                                    
100062CC | 8B75 08                  | mov esi,dword ptr ss:[ebp+8]                
100062CF | 8935 A4810210            | mov dword ptr ds:[100281A4],esi             
100062D5 | 75 48                    | jne dridex.1000631F                         
100062D7 | 803D B8810210 00         | cmp byte ptr ds:[100281B8],0                
100062DE | 74 3F                    | je dridex.1000631F                          
100062E0 | 68 E2FFE7D3              | push D3E7FFE2                               
100062E5 | 68 4CAA06DA              | push DA06AA4C                               
100062EA | C605 B8810210 00         | mov byte ptr ds:[100281B8],0                
100062F1 | E8 DA6D0000              | call dridex.1000D0D0                        
100062F6 | 85C0                     | test eax,eax                                
100062F8 | 74 14                    | je dridex.1000630E                          
100062FA | 6A 00                    | push 0                                      
100062FC | 6A 00                    | push 0                                      
100062FE | 56                       | push esi                                    
100062FF | 68 40620010              | push dridex.10006240                        
10006304 | 6A 00                    | push 0                                      
10006306 | 6A 00                    | push 0                                      
10006308 | CC                       | int3                                        
10006309 | C3                       | ret                                         
```

Now let's dump this unpacked version of the malware (based on it's memory address). The dump can be found as 'dridex_dump.exe'

But since we extracted it from memory, the import table is not yet resolved, and the sections are still in their maped form.

Original Section Header:
```
Name 	Raw Address	Raw Size	Virtual Address		Virtual Size
.text 	400		20E00		1000			20D11
.rdata	21200		6000		22000			5EFE
.data	27200		400		28000			3E8
.reloc	27600		1000		29000			EC8
```

Let's weak it a bit to obtained the unmaped version of our dump:
```
Name 	Raw Address	Raw Size	Virtual Address		Virtual Size
.text 	1000		21000		1000			20D11
.rdata	22000		6000		22000			5EFE
.data	28000		1000		28000			3E8
.reloc	29000		C000		29000			EC8
```

And now the import table is aligned and everything resolve correctely.

Last small step: restore the ImageBase field in the header to align the addresses from where we took the dump.

This unmapped version is saved as 'dridex_unmaped.exe'

Unpacked sample MD5: d7e27d10283cde67b55c5df5b8216741 (which is indeed a Dridex sample)
