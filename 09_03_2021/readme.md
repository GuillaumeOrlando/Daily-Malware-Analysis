# Nitol DOS Botnet

MD5: 71404815f6a0171a29de46846e78a079 

SHA1: 9bddfc549fed13af5f3f40a1cf91cdd26134884f 

SHA256: a467974c13cbee341c08fd0a51c28bf7cc7e482ff078a9d0ed96371b2ced5d95

Tl:Dr: Trojan that focus on Dos capabilities that levrage anti-analysis technique and obfuscation to contact a C&C server. 
May download and execute remote arbitrary files.

============================================

### Main Routine

Start by dynamically resolve some Windows API with a call to LoadLibrary() (pointing to the target DLL) followed by a GetProcAddress() call (pointing to the API name). DLL and API strings are constructed characters by characters:

```
push    eax             ; lpLibFileName <- KERNEL32.DLL string ptr
mov     [ebp+ExitProcess_String], 45h ; 'E'
mov     [ebp+ExitProcess_String+1], 78h ; 'x'
mov     [ebp+ExitProcess_String+2], 69h ; 'i'
mov     [ebp+ExitProcess_String+3], 74h ; 't'
mov     [ebp+ExitProcess_String+4], 50h ; 'P'
mov     [ebp+ExitProcess_String+5], 72h ; 'r'
mov     [ebp+ExitProcess_String+6], 6Fh ; 'o'
mov     [ebp+ExitProcess_String+7], 63h ; 'c'
mov     [ebp+ExitProcess_String+8], 65h ; 'e'
mov     [ebp+ExitProcess_String+9], 73h ; 's'
mov     [ebp+ExitProcess_String+0Ah], 73h ; 's'
mov     [ebp+ExitProcess_String+0Bh], bl
call    esi ; LoadLibraryA		<- Load Kernel32.dll in memory
push    eax             ; hModule
call    edi ; GetProcAddress		<- Get the 'ExitProcess' API address in the loaded kernel32.dll
```

Do this initializing process to resolve 'GetLastError', 'ExitProcess', 'GetCurrentThreadID', and 'CreateMutexA'.

Register the hardcoded mutex: "{650DAE86-2E8C-F6F2-AC2C-655BA4A8D4F8}"

Then, after having setup the needed DLL and registered it's mutex, the malware starts an infinite loop, with a 300 ms sleep at each loop A new thread is started at each loop, waiting for a C&C interaction (discuss later)

### System Footprint

* Version: The malware try to find the Windows version of the infected host with a call to GetVersionExA((LPOSVERSIONINFOA)v23); It tries to map the result with the following Windows version: "NT", "2000", "XP", "2003", "Vista", "2008", "2008R2", "2012", "7", "8", "8.1" A homemade boolean is used to indicate wether or not the malware is able to continue itself based on the detected Windows version

* CPU Bitness: The malware also try to detect the bitness of the CPU (32bits vs 64bits). It does it by querying the registry key "HKEY_LOCAL_MACHINE\\HARDWARE\\DESCRIPTION\\System\\CentralProcessor\\0"

* Malware bitness: The malware try to determine it's own bitness by using the GetVersionExA() function

* Hardware: The computer hardware is also query by the malicious program. The number of processor is gather with a call to GetSystemInfo() and parsing the returned struct until dwNumberOfProcessors. The number of RAM (MB) available to the application is also gathered from a GlobalMemoryStatusEx() call. Then, get some data regarding the network card stats.

Thoses data are not used to interrupt the malware in case of a suspicious env. This is transmited to the C&C server as an initial beacon to identify the infected computer.

### Networking

The C&C address and teh associated port are resolved through some calculations in an atempt to obfuscate sensitive informations. Thoses are build in two different layers:

* The first one convert the characters from the given plaintext string (0x004021F0)

* The second one takes each bytes of the strings, add 0x38 and xor it with 0x7B (hardcoded values) (0x00402324)

The plaintext value used to recover the C&C server ip is stored as a fake base64 string: "5RfY5tYdFNsX1tgd4NzeCQsTQw==" 

After the first function, this string is convert to the hex data: "E0 12 FF 01 F0 F8 0F 02 47 26 40 00 54 12 40 00 90 15" 

The deciphered final string is: "f4keu.7h4uk.com:80"

The first send beacon contains the OS fingerprint method from the previous point

### C&C Communication

After the initial beacon, the malware can receive a C&C command from the malware operator. Six operations are availables based on the response code from the C&C. A C&C response is constitued of a maximum of 24 bytes.

The 4 first bytes indicate the instruction:

* 0x02 (Raw Dos): 

  Takes 4 parameters (offset 0x8, 0x12, 0x16 and 0x20) 

  Raw socket Dos acting as the 0x04 option
* 0x03 (TCP Dos): 

  Takes 6 parameters (offset 0x8, 0x12, 0x16, 0x20, 0x24 and 0x28) 

  Launch a TCP Dos attack on a given IP/URL for a given period of time, with a custom request content 

  Based on a switch, the Dos is perform using various TCP requests: 
  * Switch 0x5: 
    * Send a GET request: 
      * "GET %s HTTP/1.1\\r\\n" "Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, application/vnd.ms-exc" "el, application/vnd.ms-powerpoint, application/msword, */*\\r\\n" "Accept-Language: zh-cn\\r\\n" "Accept-Encoding: gzip, deflate\\r\\n" "User-Agent:Mozilla/4.0 (compatible; MSIE %d.0; Windows NT %d.1; SV1)\\r\\n" "Host: %s\\r\\n" "Connection: Keep-Alive\\r\\n" "\\r\\n", 

      Or: 
      * "GET %s HTTP/1.1\\r\\n" "Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, application/vnd.ms-exc" "el, application/vnd.ms-powerpoint, application/msword, */*\\r\\n" "Accept-Language: zh-cn\\r\\n" "Accept-Encoding: gzip, deflate\\r\\n" "User-Agent:Mozilla/4.0 (compatible; MSIE %d.0; Windows NT %d.1; SV1)\\r\\n" "Host: %s:%d\\r\\n" "Connection: Keep-Alive\\r\\n" "\\r\\n" 
      * The variable part of the user agent are randomized through the GetTick() function.
        * Switch 0x6: Send a GET request: 
          * "GET %s HTTP/1.1\\r\\n" "Content-Type: text/html\\r\\n" "Host: %s\\r\\n" "Accept: text/html, */*\\r\\n" "User-Agent:Mozilla/5.0 (X11; U; Linux i686; en-US; re:1.4.0) Gecko/20080808 Firefox/%d.0\\r\\n" "\\r\\n" 
          Or: 
	  * "GET %s HTTP/1.1\\r\\n" "Referer: http://%s:80/http://%s\\r\\n" "Host: %s\\r\\n" "Connection: Close\\r\\n" "Cache-Control: no-cache\\r\\n" "\\r\\n"

        * Switch 0x7: Send a GET request: 
          * "GET %s HTTP/1.1\\r\\n" "Content-Type: text/html\\r\\n" "Host: %s\\r\\n" "Accept: text/html, */*\\r\\n" "User-Agent:Mozilla/4.0 (compatible; MSIE %d.00; Windows NT %d.0; MyIE 3.01)\\r\\n" "\\r\\n" 
          Or: 
          * "GET %s HTTP/1.1\\r\\nHost: %s\\r\\n\\r\\n" Or: "GET %s HTTP/1.1\\r\\nHost: %s:%d\\r\\n\\r\\n" Or: "GET %s HTTP/1.1\\r\\n" "Content-Type: text/html\\r\\n" "Host: %s:%d\\r\\n" "Accept: text/html, */*\\r\\n" "User-Agent:Mozilla/4.0 (compatible; MSIE %d.00; Windows NT %d.0; MyIE 3.01)\\r\\n" "\\r\\n" 

       * Switch 0x8: Send this GET request: 
          * "GET %s HTTP/1.1\\r\\n" "Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, application/vnd.ms-exc" "el, application/vnd.ms-powerpoint, application/msword, */*\\r\\n" "Accept-Language: zh-cn\\r\\n" "Accept-Encoding: gzip, deflate\\r\\n" "User-Agent:Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\\r\\n" "Host: %s\\r\\n" "Connection: Keep-Alive\\r\\n" "\\r\\n"

* 0x04 (Raw socket Dos): 
  
  Takes 4 parameters (offset 0x8, 0x12, 0x16 and 0x20) 

  Launch a raw socket Dos attack on a given IP/URL for a given period of time Spawn a multiple number of thread for each single network requests 

  Based on a switch, the Dos is perform in various way: 

  * Switch 0x15: Dos that 'connect' to a target in a loop 
  
  * Switch 0x16: Dos that send data to a target in a loop Does it for 60000 x N ms, 'N' being passed as an argument

* 0x05 (Unknown): 
  Takes no parameters, only used to set an unused variable to 1. No response send. Unknown usage

* 0x10 (Download remote file): 
  Takes 1 parameter (offset 0x8) 
  
  Download the remote file identify by the argument at offset 0x08 (URL). 

  The file is download through the urlDownloadToFile() API. 

  The file is store on the local filesystem, in the same directory as the malware. 

  The filename is randomize with the GetTickCount() function: "%d.exe"

* 0x11 (Download and execute payload): 

  Takes 1 parameter (offset 0x8) 

  Download a remote executable with the same routine than the previous option (0x10: Download a remote file) 

  Launch it with a WinExec() call.

============================================

### IOCs:

Mutex: "{650DAE86-2E8C-F6F2-AC2C-655BA4A8D4F8}" 

C&C: "f4keu.7h4uk.com:80" 

Network country code: "zh-cn" wich is the Taiwan country code 

User-agent: "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)" 

User-agent: "Mozilla/4.0 (compatible; MSIE %d.00; Windows NT %d.0; MyIE 3.01)" (%d is a random number that may be incoherent) 

User-agent: "Mozilla/4.0 (compatible; MSIE %d.0; Windows NT %d.1; SV1)" (%d is a random number that may be incoherent) 

User-agent: "Mozilla/5.0 (X11; U; Linux i686; en-US; re:1.4.0) Gecko/20080808 Firefox/%d.0" (%d is a random number that may be incoherent) 

Network Accept: "image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, application/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, */*"

============================================

### Capabilities:

* Dynamic API resolving for critical functions
* Host fingerprint including: Windows version, CPU bitness, processor number, available RAM, network cards
* C&C server obfuscation through a custom reversible algorithm
* Ability to levrage multiple Denial of Service on a given target with TCP request
* Ability to use various requests for the TCP flood Dos
* Ability to levrage multiple Denial of Service on a given target with raw sockets
* Ability to download a remote file
* Ability to download and execute a remote executable
