### Introduction:

Labeled as a coin miner on VirusBay

MD5: 8d272b695e6d435ffffd7520c756947f

Tl;Dr: Act as a simple downloader with typical anti-analysis techniques, without persitence techniques. Can be called a 'one-shot' downloader.

======================================================

### Header verification
Start by checking it's own header to validated that it is indeed a MS-DOS PE file (this is useless since it has to be in order to run and perform the actual check)

```
xor     edi, edi
push    edi             	; lpModuleName
call    ds:GetModuleHandleA 	; eax = handler to itself
cmp     word ptr [eax], 'ZM'
[...]
mov     ecx, [eax+3Ch]
add     ecx, eax
cmp     dword ptr [ecx], 'EP'
```

It basically check if it starts by 'MZ' and contains the 'PE' chars at the offset +0x3C

Poorly written: Start as a console application and hide itself with a FreeConsole() call.


### Mutex
Weird mutex creation routine (or maybe just some shady compiler optimization)
* Load the first half of the string into the XXM0 register
* Get a pseudo unallocated random memory location
* Push the buffer address ptr as a CreateMutex() name's argument
* Copy the string at this memory location
* Append the otherhalf of the mutex at this memory location, 2bytes from 2bytes.

```
movdqa  xmm0, ds:xmmword_403330 ; "-8C55-A6F60371C{"
lea     eax, [esp+1Ch]
mov     edi, ds:CreateMutexA
push    eax             ; lpName
push    1               ; bInitialOwner
push    0               ; lpMutexAttributes
movdqu  xmmword ptr [esp+59Ch+Name], xmm0
mov     dword ptr [esp+59Ch+var_564], '344A'
mov     dword ptr [esp+59Ch+var_564+4], 'AD5-'
mov     dword ptr [esp+59Ch+var_564+8], 'AE6C'
mov     word ptr [esp+59Ch+var_564+0Ch], '}' ; "A443-5DAC6EA}"
call    edi ; CreateMutexA
```

### Anti-Analysis
Anti-Analysis technique through the use of GetTickCount() before and after critical coe section (web request, persistance)

If 'GetTickCount() - tick1 >= 9000000' the malware delay itself
Delay itself with a sleeping loop for 180000 ms at least 35 times
Sleep for 60000 ms 4 times after that

Fake hardcoded C&C server as "167.179.79.234". Make some computation to retreive the real C&C server, which is "167.99.172.78".

### Downloader
Download the file "http[:]//167.99.172.78/x86" (unavailable at the time of analysis, register from a DigitalOcean Droplet (small VPS)). Write it under "C:\Users\%USERNAME%\AppData\Local\WUDHostUpgradeXXXXXX.exe", with XXXXX a random hex number get through a GetTickCount() call.

Then launch the newly created file with a CreateProcessA() call, with a StartupInfo set to hide the application.

```
xor     eax, eax
mov     [ebp+StartupInfo.cb], 44h ; 'D'
mov     [ebp+StartupInfo.wShowWindow], ax
lea     eax, [ebp+StartupInfo]
push    eax             ; lpStartupInfo
push    0               ; lpCurrentDirectory
push    0               ; lpEnvironment
push    20h ; ' '       ; dwCreationFlags
push    0               ; bInheritHandles
push    0               ; lpThreadAttributes
push    0               ; lpProcessAttributes
push    0               ; lpCommandLine
push    edi             ; lpApplicationName
mov     [ebp+StartupInfo.dwFlags], 1
call    ds:CreateProcessA
```

======================================================

### IOCs:
* Mutex: "{C17306F6A-55C8-A443-5DAC6EA}"
* File: WUDHostUpgradeXXXXXX.exe (XXXXXX is a random number from GetTickCount(), in my analysis case: 65f64b) under %TEMP%
* C&C: "167.99.172.78" port 80
* Network request:
	GET /x86 HTTP/1.1
	User-Agent: Mozilla/4.0 (compatible; MSIE 6.1; Windows NT)
	Host: 167.99.172.78
	Cache-Control: no-cache

======================================================

### Capabilities:
* Check it's own header for program validity
* Obfuscation of the disassembly code through the use of XMM registers
* Anti-Analysis through timing check GetTickCount() call
* Anti-Anaysis through delay execution
* Anti-Analysis by using a fake hardcoded C&C server IP address
* Download a remote file and execute it
